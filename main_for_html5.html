<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剪贴板历史工具（Android原生方案版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            padding: 20px;
            font-family: sans-serif;
            background: #fff;
        }

        .top-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .clipboard-label {
            flex: 1;
            font-size: 14px;
            color: #333;
            min-width: 200px;
        }

        .clear-clipboard-btn {
            padding: 8px 16px;
            background: #e63946;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            resize: none;
        }

        .tip {
            height: 30px;
            line-height: 30px;
            text-align: center;
            color: #2a9d8f;
            margin-bottom: 15px;
        }

        /* 关键修改：固定2行3列，取消小屏适配的2列 */
        .button-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        button {
            padding: 12px 0;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="clipboard-label" id="clipboardLabel">剪贴板内容：空</div>
        <button class="clear-clipboard-btn" onclick="clearClipboard()">清空剪贴板</button>
    </div>
    <!-- 绑定回车事件 -->
    <textarea id="content" placeholder="请输入要处理的内容（支持多行）" onkeydown="handleEnter(event)"></textarea>
    <div class="tip" id="tip"></div>
    <div class="button-group">
        <button style="background: #457b9d;" onclick="writeToClipboard()">写入</button>
        <button style="background: #7209b7;" onclick="writeAndClear()">写入并清空</button>
        <button style="background: #e63946;" onclick="clearOnly()">清空</button>
        <!-- 第二行：调整顺序，新增换行按钮 -->
        <button style="background: #2a9d8f;" onclick="restorePrev()">恢复上一条</button>
        <button style="background: #f4a261;" onclick="addNewLine()">换行</button>
        <button style="background: #6c757d;" onclick="clearHistory()">清空历史</button>
    </div>

    <script>
        // 内存存储历史记录（重启App丢失，无持久化）
        let history_stack = [];
        let history_index = -1;
        // Android原生剪贴板相关对象
        let plusReady = false;
        let androidClipboard = null;
        let ClipData = null;

        // 监听5+ App环境就绪，初始化原生剪贴板
        document.addEventListener('plusready', function() {
            plusReady = true;
            try {
                // 导入Android原生类
                const Context = plus.android.importClass("android.content.Context");
                const activity = plus.android.runtimeMainActivity();
                // 获取剪贴板服务
                androidClipboard = activity.getSystemService(Context.CLIPBOARD_SERVICE);
                ClipData = plus.android.importClass("android.content.ClipData");
                console.log("Android原生剪贴板初始化成功");
                // 初始化完成后获取剪贴板内容
                setTimeout(getClipboard, 300);
            } catch (err) {
                console.error("Android原生剪贴板初始化失败：", err);
                showTip("原生剪贴板初始化失败", false);
            }
        });

        // 显示提示
        function showTip(text, isSuccess = true) {
            const tip = document.getElementById('tip');
            tip.style.color = isSuccess ? '#2a9d8f' : '#e63946';
            tip.textContent = text;
            setTimeout(() => tip.textContent = '', 3000);
        }

        // --- 核心：Android原生方案 - 获取剪贴板内容 ---
        function getClipboard() {
            // 检查5+环境和剪贴板对象
            if (!plusReady || !androidClipboard) {
                showTip("请在5+ App环境中运行", false);
                return;
            }

            try {
                plus.android.importClass(androidClipboard);
                // 获取剪贴板主内容
                const clip = androidClipboard.getPrimaryClip();
                if (clip != null && clip.getItemCount() > 0) {
                    // 读取剪贴板文本内容
                    const textObj = clip.getItemAt(0).getText();
                    const text = plus.android.invoke(textObj, "toString") || "空";
                    const displayContent = text.length > 20 ? text.substring(0, 20) + "..." : text;
                    document.getElementById('clipboardLabel').textContent = `剪贴板内容：${displayContent}`;
                } else {
                    document.getElementById('clipboardLabel').textContent = "剪贴板内容：空";
                }
            } catch (err) {
                console.error("获取剪贴板失败：", err);
                showTip("获取剪贴板失败", false);
            }
        }

        // --- 核心：Android原生方案 - 写入剪贴板内容 ---
        function writeToClipboardNative(content) {
            return new Promise((resolve, reject) => {
                if (!plusReady || !androidClipboard || !ClipData) {
                    reject("原生剪贴板未初始化");
                    return;
                }
                try {
                    plus.android.importClass(androidClipboard);
                    // 创建纯文本剪贴板数据
                    const clip = ClipData.newPlainText("clipboard_content", content);
                    // 设置到系统剪贴板
                    androidClipboard.setPrimaryClip(clip);
                    resolve();
                } catch (err) {
                    reject(err);
                }
            });
        }

        // --- 写入剪贴板 ---
        async function writeToClipboard() {
            const content = document.getElementById('content').value.trim();
            if (!content) {
                showTip('输入框为空', false);
                return;
            }

            try {
                await writeToClipboardNative(content);
                history_stack.push(content);
                history_index = history_stack.length - 1;
                showTip(`✓ 已写入（共 ${history_stack.length} 条）`, true);
                getClipboard();
            } catch (err) {
                console.error("写入剪贴板失败：", err);
                showTip("写入剪贴板失败", false);
            }
        }

        // --- 清空剪贴板 ---
        async function clearClipboard() {
            try {
                // 写入空字符串清空剪贴板
                await writeToClipboardNative("");
                showTip("✓ 剪贴板已清空", true);
                getClipboard();
            } catch (err) {
                console.error("清空剪贴板失败：", err);
                showTip("清空剪贴板失败", false);
            }
        }

        // --- 写入并清空输入框 ---
        async function writeAndClear() {
            const content = document.getElementById('content').value.trim();
            if (!content) {
                showTip('输入框为空', false);
                return;
            }

            try {
                await writeToClipboardNative(content);
                history_stack.push(content);
                history_index = history_stack.length - 1;
                document.getElementById('content').value = '';
                showTip(`✓ 已写入并清空（共 ${history_stack.length} 条）`, true);
                getClipboard();
            } catch (err) {
                console.error("写入并清空失败：", err);
                showTip("写入剪贴板失败", false);
            }
        }

        // --- 仅清空输入框 ---
        function clearOnly() {
            const content = document.getElementById('content').value.trim();
            if (!content) {
                showTip('输入框已空', false);
                return;
            }
            history_stack.push(content);
            history_index = history_stack.length - 1;
            document.getElementById('content').value = '';
            showTip(`✓ 已清空输入框（共 ${history_stack.length} 条）`, true);
        }

        // --- 恢复上一条 ---
        function restorePrev() {
            if (!history_stack.length) {
                showTip("暂无历史记录", false);
                return;
            }
            if (history_index > 0) {
                history_index -= 1;
                document.getElementById('content').value = history_stack[history_index];
                showTip(`已恢复上一条（${history_index + 1}/${history_stack.length}）`, true);
            } else {
                showTip("已是第一条记录", false);
            }
        }

        // --- 恢复下一条（保留方法，备用） ---
        function restoreNext() {
            if (!history_stack.length) {
                showTip("暂无历史记录", false);
                return;
            }
            if (history_index < history_stack.length - 1) {
                history_index += 1;
                document.getElementById('content').value = history_stack[history_index];
                showTip(`已恢复下一条（${history_index + 1}/${history_stack.length}）`, true);
            } else {
                showTip("已是最后一条记录", false);
            }
        }

        // --- 清空历史 ---
        function clearHistory() {
            history_stack = [];
            history_index = -1;
            showTip("✓ 历史记录已清空", true);
        }

        // --- 新增：单独换行按钮功能 ---
        function addNewLine() {
            const contentEle = document.getElementById('content');
            // 光标位置插入换行符
            const cursorPos = contentEle.selectionStart;
            const text = contentEle.value;
            contentEle.value = text.substring(0, cursorPos) + "\n" + text.substring(cursorPos);
            // 保持光标位置在换行后
            contentEle.selectionStart = contentEle.selectionEnd = cursorPos + 1;
            contentEle.focus();
        }

        // --- 新增：回车触发写入并清空 ---
        function handleEnter(event) {
            // 判断是否是回车键，且没有按住shift（shift+回车保留换行）
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // 阻止默认换行
                writeAndClear(); // 执行写入并清空
            }
        }

        // 页面加载时检查环境
        window.onload = function() {
            if (!plusReady) {
                showTip("请在5+ App中运行本工具", false);
            }
        };
    </script>
</body>

</html>
